<!DOCTYPE html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>GBA</title>
		<link rel="stylesheet" href="resources/main.css" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
	</head>
	<body id="body">
		<canvas id="screen"></canvas>
		<section id="buttoms">

			<section id="topButtoms">
				<button id="L" class="topButtom">L</button>
				<div id="subTopButtoms">
					
					<button id="SELECT" class="topButtom">SELECT</button>
					<button id="START" class="topButtom">START</button>
					<br/>
					<label id="pixelated">
						<input
							type="checkbox"
							onchange="setPixelated(this.checked)"
						/>
						<p>Pixelated</p>
					</label>
				</div>
				<button id="R" class="topButtom">R</button>
			</section>

			<div id="space"></div>

			<section  class="gamepad">
				<div id="gamepad-left">
					<div style="flex: 1">
						<button id="UP" class="upButtom"></button>
					</div>
					<div style="flex: 1">
						<button id="LEFT" class="midButtom" style="margin-right: 15px;"></button>
						<button id="RIGHT" class="midButtom" style="margin-left: 15px;"></button>
					</div>
					<div style="flex: 1">
						<button id="DOWN" class="downButtom"></button>
					</div>
					
				</div>

				<div id="space"></div>

				<div id="gamepad-right">
					<div id="gamepad-right-div" style="align-items: flex-end;">
						<button id="A"  style="margin-left: 100px;" class="roundedButtom">A</button>
					</div>

					<div id="gamepad-right-div" style="align-items: flex-start;">
						<button id="B" style="margin-left: -100px;" class="roundedButtom">B</button>
					</div>
				</div>
			</section>
		</section>

		
		
		<!-- <section id="controls"> -->
			<!-- <div id="preload">
				<button
					class="bigbutton"
					id="select"
					onclick="document.getElementById('loader').click()"
				>
					SELECT
				</button>
				<input
					id="loader"
					type="file"
					accept=".gba"
					onchange="run(this.files[0]);"
				/>
				<button onclick="document.getElementById('saveloader').click()">
					Upload Savegame
				</button>
				<input
					id="saveloader"
					type="file"
					onchange="uploadSavedataPending(this.files[0]);"
				/>
			</div>
			<div id="ingame" class="hidden">
				<button id="pause" class="bigbutton" onclick="togglePause()">
					PAUSE
				</button>
				<button class="bigbutton" onclick="reset()">RESET</button>
				<button onclick="gba.downloadSavedata()">
					Download Savegame
				</button>
				
				<button onclick="fullScreen()">Full screen</button> -->
			<!-- </div> -->
		<!-- </section> -->

		<div id="navigateModal" class="modal">
			<div class="modal-title">
			  <p class="retro-text">Escolha o Jogo:</p>
			</div>
			<div class="modal-content">
			  <ul>
				<li onclick="run('rooms/digimon.gba')">Digimon Battle Spirits</li>
				<li onclick="run('rooms/digimon2.gba')">Digimon Battle Spirits 2</li>
			  </ul>
			</div>
		
		
	</body>
	<script src="js/util.js"></script>
		<script src="js/core.js"></script>
		<script src="js/arm.js"></script>
		<script src="js/thumb.js"></script>
		<script src="js/mmu.js"></script>
		<script src="js/io.js"></script>
		<script src="js/audio.js"></script>
		<script src="js/video.js"></script>
		<script src="js/video/proxy.js"></script>
		<script src="js/video/software.js"></script>
		<script src="js/irq.js"></script>
		<script src="js/keypad.js"></script>
		<script src="js/sio.js"></script>
		<script src="js/savedata.js"></script>
		<script src="js/gpio.js"></script>
		<script src="js/gba.js"></script>
		<script src="resources/xhr.js"></script>
		<script src="resources/biosbin.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

		<script>
			let gba;
			let runCommands = [];
			let debug = null;

			try {
				gba = new GameBoyAdvance();
				gba.keypad.eatInput = true;
				gba.setLogger(function (level, error) {
					console.log(error);
					gba.pause();
					let screen = document.getElementById('screen');
					if (screen.getAttribute('class') === 'dead') {
						console.log(
							'We appear to have crashed multiple times without reseting.'
						);
						return;
					}
				});
			} catch (exception) {
				gba = null;
			}

			
			window.onload = function () {
				if (gba && FileReader) {
					let canvas = document.getElementById('screen');
					gba.setCanvas(canvas);

					gba.logLevel = gba.LOG_ERROR;

					gba.setBios(biosBin);

					if (!gba.audio.context) {
						// Remove the sound box if sound isn't available
						let soundbox = document.getElementById('sound');
						soundbox.parentElement.removeChild(soundbox);
					}

					if (
						window.navigator.appName ===
						'Microsoft Internet Explorer'
					) {
						// Remove the pixelated option if it doesn't work
						let pixelatedBox = document.getElementById('pixelated');
						pixelatedBox.parentElement.removeChild(pixelatedBox);
					}
					// run("")
					openModal();
				} else {
					let dead = document.getElementById('controls');
					dead.parentElement.removeChild(dead);
				}
			};

			function fadeOut(id, nextId, kill) {
				let e = document.getElementById(id);
				let e2 = document.getElementById(nextId);
				if (!e) {
					return;
				}
				let removeSelf = function () {
					if (kill) {
						e.parentElement.removeChild(e);
					} else {
						e.setAttribute('class', 'dead');
						e.removeEventListener(
							'webkitTransitionEnd',
							removeSelf
						);
						e.removeEventListener('oTransitionEnd', removeSelf);
						e.removeEventListener('transitionend', removeSelf);
					}
					if (e2) {
						e2.setAttribute('class', 'hidden');
						setTimeout(function () {
							e2.removeAttribute('class');
						}, 0);
					}
				};

				e.addEventListener('webkitTransitionEnd', removeSelf, false);
				e.addEventListener('oTransitionEnd', removeSelf, false);
				e.addEventListener('transitionend', removeSelf, false);
				e.setAttribute('class', 'hidden');
			}

			function run(file) {
				// console.log("file: ", file)
				
				fetch(file)
				.then(response => response.blob()) // Converte a resposta para um objeto Blob
				.then(blob => {
					// Cria um novo objeto File a partir do objeto Blob
					const arquivo = new File([blob], 'game.gba', { type: 'application/octet-stream' });
					// console.log(arquivo);
					
					gba.loadRomFromFile(arquivo, function (result) {
					if (result) {
						for (let i = 0; i < runCommands.length; ++i) {
							runCommands[i]();
						}
						runCommands = [];
						fadeOut('preload', 'ingame');
						fadeOut('instructions', null, true);
						gba.runStable();
						closeModal()
					} else {
						load.textContent = 'FAILED';
						setTimeout(function () {
							load.textContent = 'SELECT';
							load.onclick = function () {
								document.getElementById('loader').click();
							};
						}, 3000);
					}
				});
					
					// Agora vocÃª pode trabalhar com o objeto File como desejar
				})
				.catch(error => {
					console.error('Erro ao carregar o arquivo:', error);
				});
				

				
				
			
			}

			function reset() {
				gba.pause();
				gba.reset();
				let load = document.getElementById('select');
				load.textContent = 'SELECT';
				let crash = document.getElementById('crash');
				if (crash) {
					let context = gba.targetCanvas.getContext('2d');
					context.clearRect(0, 0, 480, 320);
					gba.video.drawCallback();
					crash.parentElement.removeChild(crash);
					let canvas = document.getElementById('screen');
					canvas.removeAttribute('class');
				} else {
					lcdFade(
						gba.context,
						gba.targetCanvas.getContext('2d'),
						gba.video.drawCallback
					);
				}
				load.onclick = function () {
					document.getElementById('loader').click();
				};
				fadeOut('ingame', 'preload');
			}

			function uploadSavedataPending(file) {
				runCommands.push(function () {
					gba.loadSavedataFromFile(file);
				});
			}

			function togglePause() {
				let e = document.getElementById('pause');
				if (gba.paused) {
					if (debug && debug.gbaCon) {
						debug.gbaCon.run();
					} else {
						gba.runStable();
					}
					e.textContent = 'PAUSE';
				} else {
					if (debug && debug.gbaCon) {
						debug.gbaCon.pause();
					} else {
						gba.pause();
					}
					e.textContent = 'UNPAUSE';
				}
			}

			function lcdFade(context, target, callback) {
				let i = 0;
				let drawInterval = setInterval(function () {
					i++;
					let pixelData = context.getImageData(0, 0, 240, 160);
					for (let y = 0; y < 160; ++y) {
						for (let x = 0; x < 240; ++x) {
							let xDiff = Math.abs(x - 120);
							let yDiff = Math.abs(y - 80) * 0.8;
							let xFactor = (120 - i - xDiff) / 120;
							let yFactor =
								(80 -
									i -
									(y & 1) * 10 -
									yDiff +
									Math.pow(xDiff, 1 / 2)) /
								80;
							pixelData.data[(x + y * 240) * 4 + 3] *=
								Math.pow(xFactor, 1 / 3) *
								Math.pow(yFactor, 1 / 2);
						}
					}
					context.putImageData(pixelData, 0, 0);
					target.clearRect(0, 0, 480, 320);
					if (i > 40) {
						clearInterval(drawInterval);
					} else {
						callback();
					}
				}, 50);
			}

			function setVolume(value) {
				gba.audio.masterVolume = Math.pow(2, value) - 1;
			}

			function setPixelated(pixelated) {
				let screen = document.getElementById('screen');
				let context = screen.getContext('2d');
				context.imageSmoothingEnabled = !pixelated;
			}

			document.addEventListener(
				'webkitfullscreenchange',
				function () {
					let canvas = document.getElementById('screen');
					if (document.webkitIsFullScreen) {
						canvas.setAttribute(
							'height',
							document.body.offsetHeight
						);
						canvas.setAttribute(
							'width',
							(document.body.offsetHeight / 2) * 3
						);
						canvas.setAttribute('style', 'margin: 0');
					} else {
						canvas.setAttribute('height', 320);
						canvas.setAttribute('width', 480);
						canvas.removeAttribute('style');
					}
				},
				false
			);

			const fullScreen = () => {
				document.getElementById('screen').requestFullscreen();
			};

			function openModal() {
				document.getElementById('navigateModal').style.display = 'block';
				document.body.classList.add('modal-open');
				document.querySelector('.modal-overlay').style.display = 'block';
			};

			function closeModal() {
				document.getElementById('navigateModal').style.display = 'none';
				document.body.classList.remove('modal-open');
				document.querySelector('.modal-overlay').style.display = 'none';
				
			};
			
			
		</script>
</html>
